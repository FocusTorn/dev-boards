#!/usr/bin/env python3
"""
Cursor Rules Shared Repository Update Checker
Lightweight script to check if shared repository has updates.

Returns exit code 0 if up to date, 1 if updates available.
Can be called by VSCode/Cursor extensions or manually.

Cross-platform (Windows/Linux/Debian/macOS).
Usage:
    python check-cursor-rules-updates [--project-name=NAME]
    ./check-cursor-rules-updates [--project-name=NAME]
"""

import sys
import os
import subprocess
import argparse
import yaml
from pathlib import Path

# Fix Windows console encoding
if sys.platform == "win32":
    import io
    if hasattr(sys.stdout, 'reconfigure'):
        sys.stdout.reconfigure(encoding='utf-8')
        sys.stderr.reconfigure(encoding='utf-8')
    else:
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')


def run_git_command(cmd: list, cwd: Path, check: bool = False) -> tuple[int, str, str]:
    """Run a Git command and return exit code, stdout, stderr."""
    try:
        result = subprocess.run(
            ['git'] + cmd,
            cwd=str(cwd),
            capture_output=True,
            text=True,
            check=check
        )
        return result.returncode, result.stdout.strip(), result.stderr.strip()
    except subprocess.CalledProcessError as e:
        return e.returncode, e.stdout.strip(), e.stderr.strip()
    except FileNotFoundError:
        return 1, "", "Git is not installed or not in PATH"


def is_git_repo(path: Path) -> bool:
    """Check if a path is a Git repository."""
    return (path / '.git').exists() or (path / '.git').is_file()


def detect_project_name(shared_repo_path: Path) -> str:
    """Detect project name from current directory."""
    current = Path.cwd()
    markers = ['.git', 'pyproject.toml', 'package.json', 'Cargo.toml']
    
    project_root = None
    for marker in markers:
        test_path = current
        while test_path != test_path.parent:
            if (test_path / marker).exists():
                project_root = test_path
                break
            test_path = test_path.parent
    
    if project_root:
        return project_root.name
    
    return Path.cwd().name


def load_config(shared_repo_path: Path) -> dict:
    """Load YAML configuration file."""
    config_path = shared_repo_path / '.cursor-sync-config.yaml'
    
    if not config_path.exists():
        return {}
    
    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)
        return config
    except Exception:
        return {}


def check_updates(shared_repo_path: Path, remote: str = 'origin') -> tuple[bool, int, list[str]]:
    """Check if shared repo has updates from remote."""
    if not is_git_repo(shared_repo_path):
        return False, 0, []
    
    # Fetch latest changes (quiet mode)
    exit_code, stdout, stderr = run_git_command(
        ['fetch', remote, '--quiet'],
        shared_repo_path,
        check=False
    )
    
    # Check if local is behind remote
    exit_code, stdout, stderr = run_git_command(
        ['rev-list', '--count', f'HEAD..{remote}/HEAD'],
        shared_repo_path,
        check=False
    )
    
    if exit_code != 0:
        # Remote might not exist or branch might not be set up
        return False, 0, []
    
    commits_behind = int(stdout) if stdout else 0
    
    # Get list of changed files
    changed_files = []
    if commits_behind > 0:
        exit_code, stdout, stderr = run_git_command(
            ['diff', '--name-only', f'HEAD..{remote}/HEAD'],
            shared_repo_path,
            check=False
        )
        if exit_code == 0 and stdout:
            changed_files = [f.strip() for f in stdout.split('\n') if f.strip()]
    
    return commits_behind > 0, commits_behind, changed_files


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='Check if shared Cursor rules repository has updates'
    )
    parser.add_argument(
        '--project-name',
        help='Override detected project name'
    )
    parser.add_argument(
        '--json',
        action='store_true',
        help='Output results as JSON'
    )
    parser.add_argument(
        '--quiet',
        action='store_true',
        help='Quiet mode - only exit code'
    )
    
    args = parser.parse_args()
    
    # Find shared repo path
    current = Path.cwd()
    shared_repo_path = None
    
    # Look for ___shared/.cursor-private-git
    test_path = current
    while test_path != test_path.parent:
        candidate = test_path / '___shared' / '.cursor-private-git'
        if candidate.exists():
            shared_repo_path = candidate
            break
        test_path = test_path.parent
    
    if not shared_repo_path:
        if not args.quiet:
            print("ERROR: Could not find shared repository (___shared/.cursor-private-git)", file=sys.stderr)
        sys.exit(2)
    
    # Load configuration
    config = load_config(shared_repo_path)
    
    # Detect project name
    project_name = args.project_name or detect_project_name(shared_repo_path)
    
    # Get project configuration
    project_config = config.get('projects', {}).get(project_name, {})
    remote = project_config.get('git_remote', 'origin')
    
    # Check for updates
    has_updates, commits_behind, changed_files = check_updates(shared_repo_path, remote)
    
    if args.json:
        import json
        result = {
            'has_updates': has_updates,
            'commits_behind': commits_behind,
            'changed_files': changed_files,
            'project_name': project_name
        }
        print(json.dumps(result))
        sys.exit(0 if not has_updates else 1)
    
    if args.quiet:
        sys.exit(0 if not has_updates else 1)
    
    if has_updates:
        print(f"Updates available: {commits_behind} commit(s) behind remote")
        if changed_files:
            print(f"Changed files: {len(changed_files)}")
            for file in changed_files[:10]:
                print(f"  - {file}")
            if len(changed_files) > 10:
                print(f"  ... and {len(changed_files) - 10} more")
        sys.exit(1)
    else:
        print("Shared repository is up to date")
        sys.exit(0)


if __name__ == '__main__':
    main()




