#!/usr/bin/env python3
"""
Cross-platform uninstaller script for indeneder package.
Uninstalls using UV if available, otherwise falls back to pip.
"""

import sys
import os
import subprocess
from pathlib import Path

def check_command(cmd):
    """Check if a command is available."""
    try:
        subprocess.run([cmd, "--version"], capture_output=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def is_package_installed(package_name, use_uv=False):
    """Check if package is installed."""
    try:
        if use_uv:
            result = subprocess.run(
                ["uv", "pip", "list"],
                capture_output=True,
                text=True,
                check=True
            )
            return package_name.lower() in result.stdout.lower()
        else:
            result = subprocess.run(
                [sys.executable, "-m", "pip", "list"],
                capture_output=True,
                text=True,
                check=True
            )
            return package_name.lower() in result.stdout.lower()
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def uninstall_with_uv(package_name):
    """Uninstall package using UV."""
    print("Uninstalling with UV...")
    try:
        # UV uses 'uv pip uninstall' (no -y flag needed, UV doesn't prompt)
        result = subprocess.run(
            ["uv", "pip", "uninstall", package_name],
            capture_output=True,
            text=True,
            check=True
        )
        print("✓ Successfully uninstalled with UV")
        return True
    except subprocess.CalledProcessError as e:
        # Check if error is because package not found (that's OK)
        error_output = e.stderr or e.stdout or ""
        if "not installed" in error_output.lower() or "not found" in error_output.lower():
            print("  (Package not found in UV - may have been already removed)")
            return True  # Not an error - already uninstalled
        print(f"  ⚠ UV uninstall returned error: {error_output[:100]}")
        return False

def uninstall_with_pip(package_name):
    """Uninstall package using pip."""
    print("Uninstalling with pip...")
    try:
        result = subprocess.run(
            [sys.executable, "-m", "pip", "uninstall", "-y", package_name],
            capture_output=True,
            text=True,
            check=True
        )
        print("✓ Successfully uninstalled with pip")
        return True
    except subprocess.CalledProcessError as e:
        # Check if error is because package not found (that's OK)
        error_output = e.stderr or e.stdout or ""
        if "not installed" in error_output.lower() or "not found" in error_output.lower() or "not exist" in error_output.lower():
            print("  (Package not found in pip - may have been already removed)")
            return True  # Not an error - already uninstalled
        print(f"  ⚠ pip uninstall returned error (may be OK if already removed)")
        return False

def main():
    """Main uninstallation function."""
    package_name = "indeneder"
    
    print(f"Uninstalling {package_name}...")
    print()
    
    uv_available = check_command("uv")
    uv_installed = False
    pip_installed = False
    
    # Check where package is installed
    if uv_available:
        uv_installed = is_package_installed(package_name, use_uv=True)
        if uv_installed:
            print(f"Package found in UV environment")
    
    pip_installed = is_package_installed(package_name, use_uv=False)
    if pip_installed:
        print(f"Package found in pip environment")
    
    if not uv_installed and not pip_installed:
        print(f"Package {package_name} is not installed in either UV or pip")
        return 0  # Not an error - package already not installed
    
    print()
    uv_uninstalled = False
    pip_uninstalled = False
    
    # Try UV first if available and package is installed there
    if uv_available and uv_installed:
        print("Attempting uninstall from UV...")
        uv_uninstalled = uninstall_with_uv(package_name)
        print()
    
    # Always try pip (even if UV succeeded, in case it's installed in both)
    if pip_installed:
        print("Attempting uninstall from pip...")
        pip_uninstalled = uninstall_with_pip(package_name)
        print()
    
    # Success if:
    # 1. Package was not installed anywhere (already handled above)
    # 2. We successfully uninstalled from at least one location where it was found
    # 3. OR we attempted uninstall from all locations (some may fail if already removed by the other)
    if uv_uninstalled or pip_uninstalled:
        print("✓ Uninstallation complete")
        return 0
    elif (uv_available and uv_installed) or pip_installed:
        # We attempted uninstall from all locations where package was found
        # If both failed, it might mean package was already removed or there was an error
        # But since we checked and found it, if uninstall fails, it's likely an error
        print("⚠ Uninstallation attempted but may not have been fully successful", file=sys.stderr)
        return 1
    else:
        # Should not reach here (already handled above), but just in case
        print("✓ Uninstallation complete")
        return 0

if __name__ == "__main__":
    sys.exit(main())

