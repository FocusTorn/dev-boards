---
globs: **/*.py
alwaysApply: false
---

# Python Script to Package Migration Rules

## **CRITICAL EXECUTION DIRECTIVE**

**AI Agent Directive**: Follow Python script to package migration rules exactly for all locally installable package creation and migration tasks.

**MANDATORY EXECUTION PROTOCOL**:

1. **NO DEVIATION**: All migration rules must be followed exactly as written
2. **NO SKIPPING**: No steps may be skipped, abbreviated, or modified
3. **NO SELECTIVE COMPLIANCE**: All rules apply to all package migration activities
4. **FAILURE TO COMPLY**: Violating these rules constitutes a critical protocol violation

## **PACKAGE MANAGER SELECTION**

### **1. :: UV Preferred, Pip Fallback**

**✅ CORRECT - Use UV if available, fallback to pip**:

```python
import subprocess
import sys
from pathlib import Path

def check_command(cmd):
    """Check if a command is available."""
    try:
        subprocess.run([cmd, "--version"], capture_output=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def install_package(package_path):
    """Install package using UV if available, otherwise pip."""
    # Check for UV first
    if check_command("uv"):
        # Use UV for installation
        subprocess.run(["uv", "pip", "install", "-e", str(package_path)], check=True)
    else:
        # Fallback to pip
        subprocess.run([sys.executable, "-m", "pip", "install", "-e", str(package_path)], check=True)
```

**✅ CORRECT - Installation script pattern**:

```python
#!/usr/bin/env python3
"""
Cross-platform installer script for package.
Installs using UV if available, otherwise falls back to pip.
"""

import sys
import subprocess
from pathlib import Path

def check_command(cmd):
    """Check if a command is available."""
    try:
        subprocess.run([cmd, "--version"], capture_output=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def install_with_uv(package_path):
    """Install package using UV."""
    print("Installing with UV...")
    try:
        result = subprocess.run(
            ["uv", "pip", "install", "-e", str(package_path)],
            check=True
        )
        print("✓ Successfully installed with UV")
        return True
    except subprocess.CalledProcessError as e:
        print(f"✗ UV installation failed: {e}", file=sys.stderr)
        return False

def install_with_pip(package_path):
    """Install package using pip."""
    print("Installing with pip...")
    try:
        result = subprocess.run(
            [sys.executable, "-m", "pip", "install", "-e", str(package_path)],
            check=True
        )
        print("✓ Successfully installed with pip")
        return True
    except subprocess.CalledProcessError as e:
        print(f"✗ pip installation failed: {e}", file=sys.stderr)
        return False

def main():
    """Main installation function."""
    script_dir = Path(__file__).parent.resolve()
    package_path = script_dir
    
    # Check if pyproject.toml exists
    if not (package_path / "pyproject.toml").exists():
        print(f"Error: pyproject.toml not found in {package_path}", file=sys.stderr)
        return 1
    
    print(f"Installing package from: {package_path}")
    print()
    
    # Check for UV first
    if check_command("uv"):
        print("UV detected, using UV for installation...")
        if install_with_uv(package_path):
            return 0
        print("\nUV installation failed, falling back to pip...")
        print()
    
    # Fall back to pip
    if check_command("pip") or True:  # pip should always be available with Python
        print("Using pip for installation...")
        if install_with_pip(package_path):
            return 0
    
    print("Error: Installation failed with both UV and pip", file=sys.stderr)
    return 1

if __name__ == "__main__":
    sys.exit(main())
```

**❌ INCORRECT - Using pip without checking for UV**:

```python
# Wrong: Always using pip without checking for UV
subprocess.run([sys.executable, "-m", "pip", "install", "-e", package_path])

# Correct: Check for UV first, fallback to pip
if check_command("uv"):
    subprocess.run(["uv", "pip", "install", "-e", package_path])
else:
    subprocess.run([sys.executable, "-m", "pip", "install", "-e", package_path])
```

**❌ INCORRECT - Hardcoding package manager**:

```python
# Wrong: Hardcoding UV without fallback
subprocess.run(["uv", "pip", "install", "-e", package_path])

# Correct: Check availability and provide fallback
if check_command("uv"):
    # Use UV
else:
    # Use pip
```

## **INSTALL/UNINSTALL SCRIPTS REQUIREMENT**

### **1. :: Required Scripts**

**✅ CORRECT - All locally installable packages must include install and uninstall scripts**:

```python
# Package structure
package_name/
    pyproject.toml
    install          # Required: Installation script
    uninstall        # Required: Uninstallation script
    # ... package code ...
```

**✅ CORRECT - Install script location and naming**:

```python
# Install script must be named "install" (no extension)
# Located in package root directory
package_name/
    install          # Correct: Named "install", no extension
    uninstall        # Correct: Named "uninstall", no extension
    pyproject.toml
```

**✅ CORRECT - Install script format**:

```python
#!/usr/bin/env python3
"""
Cross-platform installer script for package.
Installs using UV if available, otherwise falls back to pip.
"""

import sys
import subprocess
from pathlib import Path

def check_command(cmd):
    """Check if a command is available."""
    try:
        subprocess.run([cmd, "--version"], capture_output=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def install_with_uv(package_path):
    """Install package using UV."""
    print("Installing with UV...")
    try:
        result = subprocess.run(
            ["uv", "pip", "install", "-e", str(package_path)],
            check=True
        )
        print("✓ Successfully installed with UV")
        return True
    except subprocess.CalledProcessError as e:
        print(f"✗ UV installation failed: {e}", file=sys.stderr)
        return False

def install_with_pip(package_path):
    """Install package using pip."""
    print("Installing with pip...")
    try:
        result = subprocess.run(
            [sys.executable, "-m", "pip", "install", "-e", str(package_path)],
            check=True
        )
        print("✓ Successfully installed with pip")
        return True
    except subprocess.CalledProcessError as e:
        print(f"✗ pip installation failed: {e}", file=sys.stderr)
        return False

def main():
    """Main installation function."""
    script_dir = Path(__file__).parent.resolve()
    package_path = script_dir
    
    # Check if pyproject.toml exists
    if not (package_path / "pyproject.toml").exists():
        print(f"Error: pyproject.toml not found in {package_path}", file=sys.stderr)
        print("Make sure you're running this script from the package directory.", file=sys.stderr)
        return 1
    
    print(f"Installing package from: {package_path}")
    print()
    
    # Check for UV first
    if check_command("uv"):
        print("UV detected, using UV for installation...")
        if install_with_uv(package_path):
            return 0
        print("\nUV installation failed, falling back to pip...")
        print()
    
    # Fall back to pip
    if check_command("pip") or True:  # pip should always be available with Python
        print("Using pip for installation...")
        if install_with_pip(package_path):
            return 0
    
    print("Error: Installation failed with both UV and pip", file=sys.stderr)
    return 1

if __name__ == "__main__":
    sys.exit(main())
```

**✅ CORRECT - Uninstall script format**:

```python
#!/usr/bin/env python3
"""
Cross-platform uninstaller script for package.
Uninstalls using UV if available, otherwise falls back to pip.
"""

import sys
import subprocess
from pathlib import Path

def check_command(cmd):
    """Check if a command is available."""
    try:
        subprocess.run([cmd, "--version"], capture_output=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def is_package_installed(package_name, use_uv=False):
    """Check if package is installed."""
    try:
        if use_uv:
            result = subprocess.run(
                ["uv", "pip", "list"],
                capture_output=True,
                text=True,
                check=True
            )
            return package_name.lower() in result.stdout.lower()
        else:
            result = subprocess.run(
                [sys.executable, "-m", "pip", "list"],
                capture_output=True,
                text=True,
                check=True
            )
            return package_name.lower() in result.stdout.lower()
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def uninstall_with_uv(package_name):
    """Uninstall package using UV."""
    print("Uninstalling with UV...")
    try:
        result = subprocess.run(
            ["uv", "pip", "uninstall", package_name],
            capture_output=True,
            text=True,
            check=True
        )
        print("✓ Successfully uninstalled with UV")
        return True
    except subprocess.CalledProcessError as e:
        error_output = e.stderr or e.stdout or ""
        if "not installed" in error_output.lower() or "not found" in error_output.lower():
            print("  (Package not found in UV - may have been already removed)")
            return True
        print(f"  ⚠ UV uninstall returned error: {error_output[:100]}")
        return False

def uninstall_with_pip(package_name):
    """Uninstall package using pip."""
    print("Uninstalling with pip...")
    try:
        result = subprocess.run(
            [sys.executable, "-m", "pip", "uninstall", "-y", package_name],
            capture_output=True,
            text=True,
            check=True
        )
        print("✓ Successfully uninstalled with pip")
        return True
    except subprocess.CalledProcessError as e:
        error_output = e.stderr or e.stdout or ""
        if "not installed" in error_output.lower() or "not found" in error_output.lower() or "not exist" in error_output.lower():
            print("  (Package not found in pip - may have been already removed)")
            return True
        print(f"  ⚠ pip uninstall returned error (may be OK if already removed)")
        return False

def main():
    """Main uninstallation function."""
    # Get package name from pyproject.toml or use default
    package_name = "package-name"  # Should be extracted from pyproject.toml
    
    print(f"Uninstalling {package_name}...")
    print()
    
    uv_available = check_command("uv")
    uv_installed = False
    pip_installed = False
    
    # Check where package is installed
    if uv_available:
        uv_installed = is_package_installed(package_name, use_uv=True)
        if uv_installed:
            print(f"Package found in UV environment")
    
    pip_installed = is_package_installed(package_name, use_uv=False)
    if pip_installed:
        print(f"Package found in pip environment")
    
    if not uv_installed and not pip_installed:
        print(f"Package {package_name} is not installed in either UV or pip")
        return 0
    
    print()
    uv_uninstalled = False
    pip_uninstalled = False
    
    # Try UV first if available and package is installed there
    if uv_available and uv_installed:
        print("Attempting uninstall from UV...")
        uv_uninstalled = uninstall_with_uv(package_name)
        print()
    
    # Always try pip (even if UV succeeded, in case it's installed in both)
    if pip_installed:
        print("Attempting uninstall from pip...")
        pip_uninstalled = uninstall_with_pip(package_name)
        print()
    
    if uv_uninstalled or pip_uninstalled:
        print("✓ Uninstallation complete")
        return 0
    elif (uv_available and uv_installed) or pip_installed:
        print("⚠ Uninstallation attempted but may not have been fully successful", file=sys.stderr)
        return 1
    else:
        print("✓ Uninstallation complete")
        return 0

if __name__ == "__main__":
    sys.exit(main())
```

**❌ INCORRECT - Missing install/uninstall scripts**:

```python
# Wrong: Package without install/uninstall scripts
package_name/
    pyproject.toml
    # Missing: install script
    # Missing: uninstall script
```

**❌ INCORRECT - Wrong script names or locations**:

```python
# Wrong: Scripts with extensions or wrong names
package_name/
    install.py      # Wrong: Should be "install" without extension
    uninstall.sh    # Wrong: Should be "uninstall" without extension
    scripts/
        install     # Wrong: Should be in package root, not subdirectory
```

## **ANTI-PATTERNS**

### **❌ Package Migration Violations**

- ❌ **Missing Install Script** - Don't create locally installable packages without install script
- ❌ **Missing Uninstall Script** - Don't create locally installable packages without uninstall script
- ❌ **Hardcoded Package Manager** - Don't hardcode UV or pip without checking availability
- ❌ **No Fallback** - Don't use UV without pip fallback
- ❌ **Wrong Script Names** - Don't use extensions or wrong names for install/uninstall scripts
- ❌ **Wrong Script Location** - Don't place install/uninstall scripts in subdirectories

## **QUALITY GATES**

- [ ] **Install Script Present**: All locally installable packages have install script in package root
- [ ] **Uninstall Script Present**: All locally installable packages have uninstall script in package root
- [ ] **Correct Script Names**: Install script named "install", uninstall script named "uninstall" (no extensions)
- [ ] **UV Preference**: Install/uninstall scripts check for UV first, fallback to pip
- [ ] **Package Manager Detection**: Scripts properly detect available package managers
- [ ] **Error Handling**: Scripts handle cases where package is already installed/not installed

## **SUCCESS METRICS**

After implementing proper script to package migration:

- ✅ **Easy Installation** - Packages can be installed with simple `./install` command
- ✅ **Easy Uninstallation** - Packages can be uninstalled with simple `./uninstall` command
- ✅ **UV Preference** - UV is used when available, pip as fallback
- ✅ **Cross-Platform** - Scripts work on Windows, Unix, and macOS
- ✅ **Robust Error Handling** - Scripts handle edge cases gracefully
