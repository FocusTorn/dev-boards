---
globs: **/*.py
alwaysApply: false
---

# Python Code Quality Rules

## **CRITICAL EXECUTION DIRECTIVE**

**AI Agent Directive**: Follow code quality rules exactly for all Python code quality and linter configuration tasks.

**MANDATORY EXECUTION PROTOCOL**:

1. **PROACTIVE RULE DISCOVERY**: Before starting ANY Python code quality or linter configuration task, MUST check for relevant rules in `.cursor/rules/by-language/python/` directory
2. **NO DEVIATION**: All code quality rules must be followed exactly as written
3. **NO SKIPPING**: No steps may be skipped, abbreviated, or modified
4. **NO SELECTIVE COMPLIANCE**: All rules apply to all code quality activities
5. **FAILURE TO COMPLY**: Violating these rules constitutes a critical protocol violation

**REQUIRED PRE-TASK CHECKLIST**:

- [ ] **Rule Discovery**: Checked `.cursor/rules/by-language/python/code-quality.mdc` before starting task
- [ ] **Rule Review**: Read and understood all relevant sections before making changes
- [ ] **Rule Application**: Applied rules from the start, not after errors appear

## **RUNTIME IMPORTS AND LINTER CONFIGURATION**

### **1. :: Scripts with sys.path Modifications**

**✅ CORRECT - Scripts that modify sys.path before importing local packages**:

```python
import sys
from pathlib import Path

# Add parent directory to path so lib package can be imported
_SCRIPT_DIR = Path(__file__).parent
_PROJECT_DIR = _SCRIPT_DIR.parent  # scripts -> project-root
sys.path.insert(0, str(_PROJECT_DIR))

# Now imports work at runtime
from lib.config import load_config  # type: ignore
from lib.output import print_info  # type: ignore
```

**✅ CORRECT - Optional local packages with fallback**:

```python
# Try to import local package with fallback
try:
    # Add shared-python to path
    _current_file = Path(__file__)
    _project_dir = _current_file.parent.parent
    _shared_dir = _project_dir.parent
    _shared_python = _shared_dir / 'shared-python'
    
    if _shared_python.exists():
        sys.path.insert(0, str(_shared_python))
        _pyprompt_dir = _shared_python / 'pyprompt'
        if _pyprompt_dir.exists():
            sys.path.insert(0, str(_pyprompt_dir))
    
    from pyprompt import select as pyprompt_select  # type: ignore
    HAS_PYPROMPT = True
except ImportError:
    HAS_PYPROMPT = False
    pyprompt_select = None
```

**❌ INCORRECT - Missing type: ignore comments**:

```python
# Wrong: Linter will show warnings for imports resolved at runtime
from lib.config import load_config  # Missing # type: ignore
from pyprompt import select  # Missing # type: ignore
```

**❌ INCORRECT - Imports before sys.path modification**:

```python
# Wrong: Import before sys.path is modified
from lib.config import load_config  # Will fail at runtime

import sys
from pathlib import Path
_SCRIPT_DIR = Path(__file__).parent
sys.path.insert(0, str(_SCRIPT_DIR.parent))
```

### **2. :: Linter Configuration**

**✅ CORRECT - pyrightconfig.json for scripts directory**:

```json
{
  "include": ["scripts", "lib", "tests"],
  "exclude": ["**/__pycache__", "**/_removed", ".uv"],
  "executionEnvironments": [
    {
      "root": "scripts",
      "pythonVersion": "3.11",
      "pythonPlatform": "All",
      "extraPaths": [
        "..",
        "../../shared-python",
        "../../shared-python/pyprompt",
        "../../shared-python/indeneder"
      ]
    }
  ],
  "pythonVersion": "3.11",
  "typeCheckingMode": "basic",
  "reportMissingImports": "none",
  "reportMissingTypeStubs": false
}
```

**✅ CORRECT - pyproject.toml configuration for basedpyright**:

```toml
[tool.basedpyright]
include = ["scripts", "lib", "tests"]
exclude = ["**/__pycache__", "**/_removed", ".uv"]
executionEnvironments = [
    { 
      root = "scripts", 
      extraPaths = [
        "..",
        "../../shared-python",
        "../../shared-python/pyprompt",
        "../../shared-python/indeneder"
      ] 
    }
]
pythonVersion = "3.11"
typeCheckingMode = "basic"
reportMissingImports = "none"
reportMissingTypeStubs = false
```

**❌ INCORRECT - Missing linter configuration**:

```python
# Wrong: No pyrightconfig.json or pyproject.toml configuration
# Linter will show warnings for all runtime imports
from lib.config import load_config  # Shows warning
```

**❌ INCORRECT - Wrong execution environment root**:

```json
{
  "executionEnvironments": [
    {
      "root": ".",  // Wrong: Should be "scripts" for files in scripts/
      "extraPaths": [".."]
    }
  ]
}
```

#### **2.1. :: Linter Verification Protocol**

**✅ CORRECT - Verify basedpyright separately**:

After calling `read_lints`, if working with Python code, verify basedpyright errors separately. The `read_lints` tool may not catch all basedpyright diagnostics. Check IDE diagnostics or basedpyright output directly.

**✅ CORRECT - Verification steps**:

1. Call `read_lints` to check for general linting errors
2. If working with Python code, also check IDE diagnostics for basedpyright errors
3. Look for `reportMissingImports` errors from basedpyright
4. If basedpyright errors are found, apply appropriate fixes (e.g., add `# type: ignore` to runtime imports)
5. **Remediate ALL detected linting errors**, even if they were pre-existing before the current changes

**✅ CORRECT - Remediate pre-existing linting errors**:

When linting errors are detected (via `read_lints` or IDE diagnostics), they MUST be remediated regardless of whether they existed before the current changes. Pre-existing linting errors should not be ignored or left unfixed.

```python
# Example: If read_lints shows a pre-existing error:
# "Import 'lib.git_ops' could not be resolved"
# This MUST be fixed, even if it existed before current changes
from lib.git_ops import commit_changes  # type: ignore  # Add type: ignore if needed
```

**❌ INCORRECT - Relying solely on read_lints**:

```python
# Wrong: Assuming read_lints catches all errors
# read_lints may not catch basedpyright errors
# Always verify basedpyright separately for Python code
```

**❌ INCORRECT - Ignoring pre-existing linting errors**:

```python
# Wrong: Not fixing linting errors because they existed before current changes
# All detected linting errors must be remediated, regardless of when they were introduced
```

### **3. :: Type Ignore Comments**

#### **3.1. :: Indirect Runtime Imports**

**✅ CORRECT - Indirect runtime imports also require type: ignore**:

Any import of a module that internally modifies `sys.path` (even if the importing file doesn't modify `sys.path` itself) qualifies as a runtime import and MUST have `# type: ignore`. This includes importing helper modules that load other packages via `sys.path` modifications.

```python
# Helper module (local_imports.py) internally modifies sys.path to load packages
from local_imports import (  # type: ignore
    write_header,
    error,
    warning,
    text,
    select,
)
```

**✅ CORRECT - Direct runtime imports**:

```python
# Imports that are resolved at runtime via sys.path modifications
from lib.config import load_config  # type: ignore
from lib.output import (  # type: ignore
    print_error, print_success, print_warning
)
from lib.sync_ops import sync_package_mapping  # type: ignore
from pyprompt import select as pyprompt_select  # type: ignore
```

**❌ INCORRECT - Missing type: ignore on indirect runtime imports**:

```python
# Wrong: local_imports.py internally modifies sys.path, so this needs type: ignore
from local_imports import write_header, error  # Missing # type: ignore
```

#### **3.2. :: Direct Runtime Imports**

**✅ CORRECT - Add type: ignore to runtime imports**:

```python
# Imports that are resolved at runtime via sys.path modifications
from lib.config import load_config  # type: ignore
from lib.output import (  # type: ignore
    print_error, print_success, print_warning
)
from lib.sync_ops import sync_package_mapping  # type: ignore
from pyprompt import select as pyprompt_select  # type: ignore
```

**✅ CORRECT - Type ignore on multi-line imports**:

```python
from lib.output import (  # type: ignore
    print_error,
    print_success,
    print_warning,
    print_info,
    print_colored,
    Colors
)
```

**❌ INCORRECT - Type ignore on wrong line**:

```python
# Wrong: type: ignore must be on the import line
from lib.config import load_config
# type: ignore  # Wrong: Must be on same line as import
```

**❌ INCORRECT - Missing type: ignore for runtime imports**:

```python
# Wrong: Missing type: ignore - linter will show warnings
from lib.config import load_config
from pyprompt import select
```

## **ANTI-PATTERNS**

### **❌ Rule Discovery Violations**

- ❌ **Missing Rule Check** - Don't start Python code quality tasks without first checking `.cursor/rules/by-language/python/code-quality.mdc`
- ❌ **Reactive Rule Application** - Don't apply rules only after errors appear - check and apply rules proactively
- ❌ **Ignoring CRITICAL EXECUTION DIRECTIVE** - Don't skip the mandatory rule discovery step in the execution protocol

### **❌ Runtime Import Violations**

- ❌ **Missing Type Ignore** - Don't skip `# type: ignore` on imports resolved via sys.path
- ❌ **Imports Before Path Setup** - Don't import local packages before modifying sys.path
- ❌ **Missing Linter Config** - Don't skip pyrightconfig.json or pyproject.toml configuration
- ❌ **Wrong Execution Environment** - Don't use wrong root in executionEnvironments
- ❌ **Hardcoded Absolute Paths** - Prefer relative paths in config when possible (use absolute only if relative doesn't work)
- ❌ **Ignoring Pre-Existing Errors** - Don't skip fixing linting errors because they existed before current changes

## **QUALITY GATES**

- [ ] **Rule Discovery**: Checked `.cursor/rules/by-language/python/code-quality.mdc` before starting task
- [ ] **Type Ignore Comments**: All runtime imports have `# type: ignore` comments
- [ ] **Path Setup Before Imports**: sys.path modifications occur before importing local packages
- [ ] **Linter Configuration**: pyrightconfig.json or pyproject.toml has executionEnvironments configured
- [ ] **Correct Root**: executionEnvironments root matches the directory containing the script
- [ ] **Extra Paths**: All runtime paths are included in extraPaths
- [ ] **Report Missing Imports**: Set to "none" to suppress warnings for runtime imports
- [ ] **Pre-Existing Error Remediation**: All detected linting errors (including pre-existing ones) have been remediated

## **SUCCESS METRICS**

After implementing proper runtime import handling:

- ✅ **No Linter Warnings** - All runtime imports properly configured
- ✅ **Clean Code** - Type ignore comments clearly mark runtime imports
- ✅ **Proper Configuration** - Linter understands runtime path modifications
- ✅ **Maintainable** - Future developers understand why type: ignore is needed

## **EXECUTION PRIORITY MATRIX**

### **CRITICAL PRIORITY (Execute immediately)**

- **Check relevant rules files** - Before starting task, check `.cursor/rules/by-language/python/code-quality.mdc` for applicable rules
- Add `# type: ignore` to all imports resolved via sys.path modifications
- Configure pyrightconfig.json or pyproject.toml with executionEnvironments
- Ensure sys.path modifications occur before imports

### **HIGH PRIORITY (Execute before proceeding)**

- Verify linter configuration is correct for script location
- Test that imports work at runtime
- Verify linter warnings are suppressed

### **MEDIUM PRIORITY (Execute during normal operation)**

- Document why type: ignore is needed in code comments
- Keep linter configuration up to date as paths change

## **DYNAMIC MANAGEMENT NOTE**

This document is optimized for AI agent internal processing and may be updated dynamically based on operational needs and pattern recognition. The structure prioritizes AI agent compliance and effectiveness over traditional documentation practices. Additional code quality rules may be added to this document as needed.
