---
trigger: always_on
---

# Gcode Script Formatting and Comment Rules

## **CRITICAL EXECUTION DIRECTIVE**

**AI Agent Directive**: Follow gcode formatting and comment rules exactly for all gcode script files.

**MANDATORY EXECUTION PROTOCOL**:

1. **NO DEVIATION**: All gcode formatting rules must be followed exactly as written
2. **NO SKIPPING**: No steps may be skipped, abbreviated, or modified
3. **NO SELECTIVE COMPLIANCE**: All rules apply to all gcode files
4. **FAILURE TO COMPLY**: Violating these rules constitutes a critical protocol violation

## **TEMPERATURE COMMAND COMMENTS**

### **1. :: Temperature Command Comment Format**

**✅ CORRECT - Use "[No Wait]" / "[Wait]" format with brackets**:

```gcode
M104 S140 ; [No Wait] Nozzle to 140°
M140 S100 ; [No Wait] Bed to 100°
M109 S250 ; [Wait] Nozzle at 250°
M190 S60  ; [Wait] Bed at 60°
```

**✅ CORRECT - With additional explanatory context**:

```gcode
M104 S140 ; [No Wait] Nozzle to 140°
M140 S[bed_temperature_initial_layer_single] ; [No Wait] Bed to initial temp
M109 S{nozzle_temperature_initial_layer[initial_extruder]} ; [Wait] Nozzle at print temp
M190 S100 ; [Wait] Bed at 100° (heatsoak temp, pause will occur later)
```

**✅ CORRECT - Conditional formatting example**:

```gcode
{if filament_type[initial_extruder]=="ASA" || filament_type[initial_extruder]=="ABS"}
    M140 S100 ; [No Wait] Bed to 100° for heatsoak
{else}
    M140 S[bed_temperature_initial_layer_single] ; [No Wait] Bed to initial temp
{endif}
```

**❌ INCORRECT - Don't use "non-blocking" or "blocking" terminology**:

```gcode
M104 S140 ; Non-blocking nozzle heating to 140°C
M140 S100 ; Start bed heating (non-blocking)
M109 S250 ; Blocking wait for nozzle temperature
```

**❌ INCORRECT - Missing temperature values**:

```gcode
M104 S140 ; Start heating nozzle
M140 S100 ; Start heating bed
```

### **2. :: Temperature Comment Components**

**✅ CORRECT - Required components**:

1. **Action Type**: "[No Wait]" for M104/M140, "[Wait]" for M109/M190 (must use brackets)
2. **Component**: "Nozzle" or "Bed" (capitalize first letter)
3. **Temperature**: Include actual temperature value with ° symbol
4. **Additional Context**: Optional explanatory notes after temperature

**✅ CORRECT - Comment structure**:

```
M104/M140: ; [No Wait] [Component] to [temp]° [optional context]
M109/M190: ; [Wait] [Component] at [temp]° [optional context]
```

**✅ CORRECT - Examples**:

```gcode
M104 S140 ; [No Wait] Nozzle to 140°
M140 S100 ; [No Wait] Bed to 100° for heatsoak
M109 S250 ; [Wait] Nozzle at 250°
M190 S60  ; [Wait] Bed at 60°
```

**❌ INCORRECT - Missing components**:

```gcode
M104 S140 ; Heating
M140 S100 ; Bed heating
M109 S250 ; Wait
```

### **3. :: Variable Temperature Values**

**✅ CORRECT - Include variable reference in comment**:

```gcode
M104 S{nozzle_temperature_initial_layer[initial_extruder]} ; [No Wait] Nozzle to print temp
M140 S[bed_temperature_initial_layer_single] ; [No Wait] Bed to initial temp
M109 S{nozzle_temperature_range_high[initial_extruder]} ; [Wait] Nozzle at max temp
```

**✅ CORRECT - Use descriptive context for variables**:

```gcode
M104 S{nozzle_temperature_initial_layer[initial_extruder]} ; [No Wait] Nozzle to initial layer temp
M140 S[bed_temperature_initial_layer_single] ; [No Wait] Bed to initial temp
M109 S{nozzle_temperature_range_high[initial_extruder]} ; [Wait] Nozzle at max temp
```

**❌ INCORRECT - Unclear variable references**:

```gcode
M104 S{temp} ; No wait nozzle to temp
M140 S[temp-4] ; No wait bed
```

## **SECTION HEADERS AND COMMENTS**

### **4. :: Section Header Format**

**✅ CORRECT - Visual box headers for major sections**:

```gcode
; ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
; │                                    SECTION TITLE                                                                    │
; │                                    (Optional subtitle)                                                              │
; └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

**✅ CORRECT - Standard section dividers**:

```gcode
;===== SECTION NAME ======================================================================================
```

**✅ CORRECT - Subsection dividers**:

```gcode
;== SUBSECTION NAME =========================================================================== 
```

**❌ INCORRECT - Inconsistent formatting**:

```gcode
; Section Name
;=====SECTION NAME=====
;--- Section Name ---
```

### **5. :: Comment Clarity**

**✅ CORRECT - Clear, descriptive comments**:

```gcode
M960 S5 P1  ; Turn on logo lamp for visibility
G392 S0     ; Disable clog detection during startup (prevents false positives)
M9833.2     ; Mandatory system command (required for proper initialization)
```

**✅ CORRECT - Explain "why" not just "what"**:

```gcode
M140 S[bed_temperature_initial_layer_single-4] ; No wait bed to initial temp -4° (offset allows bed to reach target during initialization)
M17 Z0.3    ; Reduce Z motor current before reset (prevents excessive force during homing)
```

**❌ INCORRECT - Vague or obvious comments**:

```gcode
M960 S5 P1  ; Turn on lamp
G392 S0     ; Turn off clog detect
M140 S100   ; Set bed temp
```

## **CODE ORGANIZATION**

### **6. :: Command Grouping**

**✅ CORRECT - Group related commands**:

```gcode
; Initial heating (all non-blocking for parallel execution)
M104 S140 ; No wait nozzle to 140°
M140 S100 ; No wait bed to 100°

; System configuration
M960 S5 P1  ; Turn on logo lamp
G392 S0     ; Disable clog detection
M9833.2     ; Mandatory system command
```

**✅ CORRECT - Add blank lines between logical groups**:

```gcode
M1002 set_filament_type:{filament_type[initial_no_support_extruder]}

M104 S140 ; No wait nozzle to 140°

M1002 gcode_claim_action : 2 ; Message: Heatbed preheating
```

**❌ INCORRECT - No organization or grouping**:

```gcode
M1002 set_filament_type:{filament_type[initial_no_support_extruder]}
M104 S140
M1002 gcode_claim_action : 2
M140 S100
M960 S5 P1
G392 S0
```

### **7. :: Conditional Logic Formatting**

**✅ CORRECT - Clear conditional formatting**:

```gcode
{if filament_type[initial_extruder]=="ASA" || filament_type[initial_extruder]=="ABS"}
    M140 S100 ; [No Wait] Bed to 100° for heatsoak
{else}
    M140 S[bed_temperature_initial_layer_single] ; [No Wait] Bed to initial temp
{endif}
```

**✅ CORRECT - Indent conditional blocks**:

```gcode
{if condition}
    ; Commands indented 4 spaces
    M104 S140
{else}
    ; Alternative commands
    M104 S120
{endif}
```

**❌ INCORRECT - Inconsistent indentation**:

```gcode
{if condition}
M104 S140
{else}
M104 S120
{endif}
```

## **ANTI-PATTERNS**

### **❌ Gcode Formatting Violations**

- ❌ **Using "non-blocking"/"blocking"** - Don't use technical terminology, use "[No Wait]"/"[Wait]" with brackets
- ❌ **Missing Brackets** - Always use brackets: "[No Wait]" not "No wait", "[Wait]" not "Wait"
- ❌ **Missing Temperature Values** - Always include temperature with ° symbol in comments
- ❌ **Vague Comments** - Don't write comments that don't add value or explain purpose
- ❌ **Inconsistent Formatting** - Don't mix different header styles or comment formats
- ❌ **No Grouping** - Don't place unrelated commands together without organization
- ❌ **Missing Context** - Don't skip explanatory notes when they clarify important behavior
- ❌ **Unclear Variables** - Don't reference variables without describing what they represent

## **QUALITY GATES**

- [ ] **Temperature Comments**: All M104/M140/M109/M190 commands have "[No Wait]"/"[Wait]" format with brackets
- [ ] **Bracket Format**: Action type uses brackets: "[No Wait]" or "[Wait]"
- [ ] **Temperature Values**: All temperature commands include actual temperature in comment
- [ ] **Section Headers**: Major sections use visual box headers or consistent divider format
- [ ] **Command Grouping**: Related commands are grouped with blank lines between groups
- [ ] **Conditional Formatting**: Conditional blocks are properly indented and formatted
- [ ] **Comment Clarity**: Comments explain "why" not just "what"
- [ ] **Additional Context**: Important behaviors have explanatory notes in parentheses

## **SUCCESS METRICS**

After implementing proper gcode formatting:

- ✅ **Clear Temperature Actions** - All temperature commands clearly indicate wait/no-wait behavior with bracketed format
- ✅ **Consistent Formatting** - All sections follow same header and comment style
- ✅ **Easy to Understand** - Comments explain purpose and important behaviors
- ✅ **Well Organized** - Commands grouped logically with clear separation
- ✅ **Maintainable** - Future modifications are easy to make with clear structure

## **EXECUTION PRIORITY MATRIX**

### **CRITICAL PRIORITY (Execute immediately)**

- **Temperature Comment Format**: All M104/M140/M109/M190 must have proper "[No Wait]"/"[Wait]" format with brackets
- **Temperature Values**: All temperature comments must include actual temperature with °
- **Section Organization**: Major sections must have clear headers and grouping

### **HIGH PRIORITY (Execute before proceeding)**

- **Additional Context**: Important behaviors must have explanatory notes
- **Command Grouping**: Related commands must be grouped together
- **Conditional Formatting**: Conditional blocks must be properly indented

### **MEDIUM PRIORITY (Execute during normal operation)**

- **Comment Clarity**: Comments should explain purpose, not just action
- **Formatting Consistency**: All sections should follow same formatting style

## **DYNAMIC MANAGEMENT NOTE**

This document is optimized for AI agent internal processing and may be updated dynamically based on operational needs and pattern recognition. The structure prioritizes AI agent compliance and effectiveness over traditional documentation practices.
