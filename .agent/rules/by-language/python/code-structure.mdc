---
globs: **/*.py

---

# Code Structure Rules

## **CRITICAL EXECUTION DIRECTIVE**

**AI Agent Directive**: Follow code structure rules exactly for all Python exception handling and control flow patterns.

**MANDATORY EXECUTION PROTOCOL**:

1. **NO DEVIATION**: All structure rules must be followed exactly as written
2. **NO SKIPPING**: No steps may be skipped, abbreviated, or modified
3. **NO SELECTIVE COMPLIANCE**: All rules apply to all code structure patterns
4. **FAILURE TO COMPLY**: Violating these rules constitutes a critical protocol violation

## **NESTED TRY-EXCEPT-FINALLY BLOCKS**

### **1. :: Proper Structure**

**✅ CORRECT - Nested try-except-finally structure**:

```python
# Outer try block
try:
    import tty
    import termios
    
    # Inner try block
    try:
        # Set terminal to raw mode
        tty.setraw(sys.stdin.fileno())
        
        # Read character
        char = sys.stdin.read(1)
        
        # Handle character
        return process_char(char)
    
    # Finally belongs to inner try
    finally:
        # Always restore terminal settings
        termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)

# Except belongs to outer try (same indentation level)
except (ImportError, AttributeError, OSError):
    # Handle outer try exceptions
    return fallback_behavior()
```

**✅ CORRECT - Indentation alignment**:

```python
try:  # Level 0
    try:  # Level 1 (nested)
        # Code
        pass
    finally:  # Level 1 (belongs to inner try)
        # Cleanup
        pass
except Exception:  # Level 0 (belongs to outer try, same level as outer try)
    # Handle exception
    pass
```

**❌ INCORRECT - Except after finally at wrong level**:

```python
try:
    try:
        # Code
        pass
    finally:
        # Cleanup
        pass
    except Exception:  # Wrong: except after finally, wrong indentation
        pass
```

**❌ INCORRECT - Except nested inside finally**:

```python
try:
    try:
        # Code
        pass
    finally:
        # Cleanup
        except Exception:  # Wrong: except inside finally block
            pass
```

### **2. :: Exception Handling Flow**

**✅ CORRECT - Exception propagation**:

```python
try:
    try:
        risky_operation()
    finally:
        cleanup()  # Always executes, even if exception occurs
except SpecificError:  # Catches exceptions from outer try
    handle_error()
```

**✅ CORRECT - Multiple exception handlers**:

```python
try:
    try:
        operation_a()
    finally:
        cleanup_a()
    
    try:
        operation_b()
    finally:
        cleanup_b()
except (ErrorA, ErrorB):  # Handles exceptions from both inner tries
    handle_errors()
```

**❌ INCORRECT - Misaligned exception handlers**:

```python
try:
    try:
        operation()
    finally:
        cleanup()
        except Exception:  # Wrong: except inside finally
            handle()
```

## **ANTI-PATTERNS**

### **❌ Structure Violations**

- ❌ **Except After Finally** - Don't place except blocks after finally blocks at same indentation level
- ❌ **Except Inside Finally** - Don't nest except blocks inside finally blocks
- ❌ **Misaligned Except** - Don't place except blocks at incorrect indentation levels
- ❌ **Missing Finally Cleanup** - Don't skip finally blocks when cleanup is needed

## **QUALITY GATES**

- [ ] **Proper Structure**: All try-except-finally blocks follow correct nesting pattern
- [ ] **Correct Indentation**: Except clauses align with their corresponding try blocks
- [ ] **Cleanup Guaranteed**: Finally blocks used for required cleanup operations
- [ ] **Exception Handling**: Exceptions properly caught at appropriate levels

## **SUCCESS METRICS**

After implementing proper code structure:

- ✅ **No Syntax Errors** - All nested blocks properly structured
- ✅ **Correct Exception Flow** - Exceptions handled at appropriate levels
- ✅ **Guaranteed Cleanup** - Finally blocks ensure cleanup always executes
- ✅ **Maintainable Code** - Clear exception handling structure
